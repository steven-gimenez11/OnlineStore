{% extends 'layouts/g.html' %}

{% block content %}
{% load price_filters %}
{% load static %}
{% load custom_filters %}

<div class="flex flex-col h-screen text-center justify-between rounded p-4 opacity-0" _="on load transition my opacity to 1 over 0.3 seconds">
    <div>
        <div class="py-4 border-b border-gray-200">
            <h1 class="text-2xl font-bold">Tu carrito de compras</h1>
        </div>
        <div class="p-6">
            {% if cart_products %}
            <ul class="flex flex-col">
                {% for product in cart_products %}
                <li class="flex flex-col sm:flex-row items-center space-x-4 my-2" id="product-{{ product.id }}">
                    <img src="{{ product.image.url }}" alt="{{ product.title }}" class="w-40 object-cover rounded">
                    <div class="flex-1">
                        <h3 class="font-semibold">{{ product.title }}</h3>
                        <p class="text-sm text-gray-600">{{ product.price|formato_precio }}</p>
                    </div>

                    <div class="flex flex-col md:flex-row items-center gap-5 pb-7">
                        Cantidad:
                        <select id="select{{ product.id }}" class="block appearance-none w-auto bg-white border border-gray-300 text-gray-700 py-3 px-3 rounded leading-tight focus:outline-none focus:bg-white focus:border-gray-500">
                            {% for key, value in quantities.items %}
                                {% if key == product.id|stringformat:"s" %}
                                    <option selected>{{ value }}</option>
                                {% endif %}
                            {% endfor %}
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                        <div class="flex gap-5">
                            <button data-index="{{ product.id }}" class="p-3 update-cart text-sm">Actualizar</button>
                            <button id="delete-product-{{ product.id }}" data-index="{{ product.id }}" class="w-10 p-2 bg-red-600 hover:bg-red-800 text-sm">
                                <img class="w-full" src="https://img.icons8.com/small/64/ffffff/delete-sign.png" alt="delete-product">
                            </button>
                        </div>
                    </div>

                    <!-- total por producto -->
                    <div class="text-sm font-semibold text-gray-600" id="product-{{ product.id }}-total">
                        {% if product_totals|get_item:product.id %}
                            Total: {{ product_totals|get_item:product.id|formato_precio }}
                        {% else %}
                            Total no disponible
                        {% endif %}
                    </div>                    
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-center text-gray-600">Tu carrito está vacío</p>
            {% endif %}
        </div>
    </div>
</div>

<div class="absolute top-80" hx-trigger="load">
    <img alt="Result loading..." class="htmx-indicator loader" width="150" src="{% static 'images/logo.png' %}"/>
</div>

<div class="flex justify-between items-center py-4">
    <span class="font-semibold text-xl">Total del carrito:</span>
    <span class="text-lg font-bold" id="cart-total">{{ total|formato_precio }}</span>
</div>

<script>
$(document).on('click', '.update-cart', function(e) {
    e.preventDefault();
    let productid = $(this).data('index');
    let quantity = $('#select' + productid + ' option:selected').val();
    
    $.ajax({
        type: 'POST',
        url: '{% url "cart_update" %}',
        data: {
            product_id: productid,
            product_qty: quantity,
            csrfmiddlewaretoken: '{{ csrf_token }}',
            action: 'post'
        },
        success: function(response) {
            // Actualiza los valores en el front-end
            $('#product-' + productid + '-total').text(response.product_total); 
            $('#cart-total').text(response.cart_total);  
        },
        error: function(xhr, errmsg, err) {
            console.log('Error updating cart:', errmsg);
        }
    });
});


    
    $(document).on('click', '[id^="delete-product-"]', function(e) {
        e.preventDefault();
        let productid = $(this).data('index');
        
        $.ajax({
            type: 'POST',
            url: '{% url "cart_delete" %}',
            data: {
                product_id: productid,
                csrfmiddlewaretoken: '{{ csrf_token }}',
                action: 'post'
            },
            success: function(response) {
                $('#product-' + productid).remove();
                $('#cart-total').text(response.cart_total);
                window.location.reload(); 
            },
            error: function(xhr, errmsg, err) {
                console.log('Error deleting product:', errmsg);
            }
        });
    });
</script>

{% endblock %}
